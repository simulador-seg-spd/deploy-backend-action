name: Deploy Backend
on:
  workflow_dispatch: # Permite iniciar manualmente o deploy via interface do GitHub
  workflow_call:
    input:
      project-language:
        type: string
        required: true
      aws-ecr-repository:
        type: string
        required: true
      aws-region:
        type: string
        required: true
      aws-account-id:
        type: string
        required: true
      stack-name:
        type: string
        required: true
permissions:
  id-token: write
  contents: read
  actions: write

jobs:
  build_and_push_image:
    name: Build image and upload to ecr
    uses: ./.github/workflows/ci.yml
    with:
      project-language: ${{ inputs.project-language }}
      AWS_ECR_REPOSITORY: ${{ inputs.aws-ecr-repository }}
      AWS_REGION: ${{ inputs.aws-region }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

  deploy_to_ecs:
    name: Deploy image to ecs
    needs: build_and_push_image
    uses: ./.github/workflows/cd.yml
    with:
      stack-name: ${{ inputs.stack-name }}
      AWS_ECR_REPOSITORY: ${{ inputs.aws-ecr-repository }}
      AWS_REGION: ${{ inputs.aws-region }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      ImageUrl: ${{ needs.build_and_push_image.outputs.image-url }}
